---
name: "ci: release"
on:
  release:
    types: [published]

jobs:
  extract-project:
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 5
    outputs:
      project: ${{ steps.extract.outputs.project }}
      version: ${{ steps.extract.outputs.version }}
    steps:
    - name: "Extract project and version from tag"
      id: extract
      run: |
        TAG="${{ github.event.release.tag_name }}"

        PROJECT=$(echo "${TAG}" | cut -d'@' -f1)
        if [ -z "$PROJECT" ]; then
          echo "Error: Could not extract project name from tag"
          exit 1
        fi

        VERSION=$(echo "${TAG}" | cut -d'@' -f2)
        if [ -z "$VERSION" ]; then
          echo "Error: Could not extract version from tag"
          exit 1
        fi

        echo "project=$PROJECT" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted project: $PROJECT, version: $VERSION"

  dashboard:
    needs: extract-project
    if: needs.extract-project.outputs.project == '@nhost/dashboard'
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 30

    permissions:
      id-token: write
      contents: read

    steps:
    - name: "Deploy dashboard"
      run: |
        echo "Deploying dashboard version ${{ needs.extract-project.outputs.version }}"

  nhost-js:
    needs: extract-project
    if: needs.extract-project.outputs.project == '@nhost/nhost-js'
    uses: ./.github/workflows/wf_release_npm.yaml
    with:
      NAME: nhost-js
      PATH: packages/nhost-js
      VERSION: ${{ needs.extract-project.outputs.version }}
    secrets:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_PRODUCTION_CORE_ACCOUNT_ID }}
      NIX_CACHE_PUB_KEY: ${{ secrets.NIX_CACHE_PUB_KEY }}
      NIX_CACHE_PRIV_KEY: ${{ secrets.NIX_CACHE_PRIV_KEY }}
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
