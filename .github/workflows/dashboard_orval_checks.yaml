---
on:
  workflow_call:
    inputs:
      NAME:
        type: string
        required: true
      PATH:
        type: string
        required: true
      GIT_REF:
        type: string
        required: false
    secrets:
      AWS_ACCOUNT_ID:
        required: true
      NIX_CACHE_PUB_KEY:
        required: true
      NIX_CACHE_PRIV_KEY:
        required: true

jobs:
  check-orval-codegen:
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 10

    defaults:
      run:
        working-directory: ${{ inputs.PATH }}

    permissions:
      id-token: write
      contents: read

    steps:
      - name: "Check out repository"
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.GIT_REF }}

      - name: Configure aws
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-nhost-${{ github.event.repository.name }}
          aws-region: eu-central-1

      - name: Setup Nix with Cache
        uses: ./.github/actions/setup-nix
        with:
          NAME: ${{ inputs.NAME }}
          NIX_CACHE_PUB_KEY: ${{ secrets.NIX_CACHE_PUB_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "Run Orval codegen"
        run: |
          nix develop ..\#${{ inputs.NAME }} -c pnpm codegen-hasura-api

      - name: "Check for uncommitted changes"
        working-directory: .
        run: |
          git diff --exit-code ${{ inputs.PATH }}/src/utils/hasura-api/generated/ || {
            echo "❌ Generated files are out of date. Please run 'pnpm codegen-hasura-api' and commit the changes."
            git diff ${{ inputs.PATH }}/src/utils/hasura-api/generated/
            exit 1
          }
          echo "✅ Generated files are up to date."

      - name: "Store Nix cache"
        uses: ./.github/actions/cache-nix
        with:
          NIX_CACHE_PRIV_KEY: ${{ secrets.NIX_CACHE_PRIV_KEY }}
        if: always()
