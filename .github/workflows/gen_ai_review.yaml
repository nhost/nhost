---
name: "gen: AI review"
on:
  pull_request_target:
    types: [opened, reopened, ready_for_review]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  opencode:
    if: |
      (
        github.event_name == 'pull_request_target' &&
        contains(fromJson('["OWNER","MEMBER"]'), github.event.pull_request.author_association)
      ) ||
      (
        (startsWith(github.event.comment.body, '/opencode') || startsWith(github.event.comment.body, '/oc')) &&
        (github.event.issue.pull_request || github.event.pull_request) &&
        contains(fromJson('["OWNER","MEMBER"]'), github.event.comment.author_association)
      )
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 15
    permissions:
      id-token: write
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          persist-credentials: false  # Prevents duplicate Authorization header
      - name: Run opencode
        uses: anomalyco/opencode/github@latest
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          model: ${{ vars.OPENCODE_PR_REVIEW_MODEL }}
          use_github_token: true
          share: false
          prompt: |
            Review this pull request with focus on:
            - Code quality and best practices
            - Security vulnerabilities
            - Performance implications
            - Breaking changes
            - Test coverage
            - Documentation updates needed

            Please provide specific, actionable feedback.
            Do not attempt to push changes, only suggest them in the review.

            Additionally, update the PR description if needed:
            - Summarize key changes
            - Do not suggest description changes in a comment, update the description directly.
            - If there is a description already, improve it rather than replacing it entirely.

            Do not:
            - Duplicate information in the PR description and comments.
            - Make assumptions about the code outside of the diff.
            - Add multiple comments on the same PR
