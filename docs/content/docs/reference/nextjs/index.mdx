---
title: 'Introduction'
---

It is possible to use [`@nhost/react`](./react) to any Next.js page that would be configured to render on the client side.

When rendering a page from the server side, Next.js needs to get some information from the client to determine their authentication status. Such a communication is only available from cookies, and the the [`@nhost/client`](./supporting-libraries/client) has been designed to enable such a mechanism.

The cookie is `same-site` and is used only stores the refresh cookie and the expiration date of the JWT so the browser can proactively ask for a new JWT before it expires.

## Sign-in

There is no need to activate SSR in the sign-in page as there is not yet any session information to capture. As a result, it is recommended to code it as a classic static page.

The intitial authentication would then work like this diagram:

```mermaid
sequenceDiagram
    participant Browser
    participant Next.js
    Browser->>Auth: Authenticate
    activate Browser
    activate Auth
    Auth-->>Browser: New refresh token + JWT + user data
    deactivate Auth
    Browser->>Browser: Set the new refresh token in the cookie
    deactivate Browser
```

## Refresh the JWT token

For security considerations, the Nhost JS tools never persist the JWT anywhere in the browser either in `localStorage` or in a cookie, and the JWT expires regularily (15 minutes by default). As a result, the Nhost client regularly call the `hasura-auth` service to get a new JWT from a valid refresh tooken. The new JWT is emitted together with a new refresh token, while the old one is invalidated.
As a result, it is important to ensure both the browser and the Next.js will always use the last refresh token, as it will be the only one that is still valid.
The above diagram illustrates how a JWT is renewed, while making sure the refresh token is updated:

```mermaid
sequenceDiagram
    Browser->>Auth: Initial refresh token
    activate Browser
    activate Auth
    Auth-->>Browser: New refresh token + JWT + user data
    Browser->>Browser: Set the new refresh token in the cookie
    deactivate Browser
```

## Loading a SSR page

When Nhost is activated on a specific page, the Next.js server will first check the refresh token in the cookie. If it is present, it will call the `hasura-auth` service to refresh the JWT, user data and the new refresh cookie.
It then:

- sets the new refresh cookie in the response headers
- hydrates the page with user data and JWT
- renders the page on the server side. At this stage, an authenticated GraphQL call can be done on the server-side as a valid JWT is available

Once the SSR page is loaded, it is still possible to refetch data from Hasura as the JWT will then be available in the browser, and kept up to date as explained in the above diagram.

```mermaid
sequenceDiagram
    Browser->>Next.js: Request SSR page (refresh token in cookie)
    activate Browser
    activate Next.js
    Next.js->>Auth: Refresh token
    activate Auth
    Auth-->>Next.js: New refresh token + JWT + user data
    deactivate Auth
    Next.js->>Next.js: Set the new refresh token in the cookie
    Next.js->>Next.js: getInitialProps - Hydrate JWT + user data
    Next.js->>Hasura: GraphQL operation with JWT
    Hasura-->>Next.js: GraphQL data
    Next.js->>Next.js: Render page
    Next.js-->>Browser: HTML with JWT + user data + new refresh token in the cookie
    deactivate Next.js
    deactivate Browser
    Browser->>Hasura: Refetch data with JWT
    activate Browser
    activate Hasura
    Hasura-->>Browser: Updated data
    deactivate Hasura
    Browser->>Browser: Re-render data
    deactivate Browser
```

## Loading a static page

It is still possible to use the Nhost SDK in a more classic 'React' mode. It will then be handlded in a very similar way, except that the refresh token will be stored in the cookie instead of `localStorage`.

```mermaid
sequenceDiagram
    Browser->>Next.js: Request static page (refresh token in the cookie)
    activate Browser
    activate Next.js
    Next.js-->>Browser: Static page (same cookie)
    deactivate Next.js
    Browser->>Browser: Render "loading data" page
    Browser->>Hasura: GraphQL operation with JWT
    activate Hasura
    Hasura-->>Browser: GraphQL data
    deactivate Hasura
    Browser->>Browser: Render data
    deactivate Browser
```
