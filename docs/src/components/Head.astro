---
import Default from '@astrojs/starlight/components/Head.astro';
import type { Props } from '@astrojs/starlight/props';

// Keywords for SEO: Renders <meta name="keywords"> in <head> for external search engines (Google, etc.)
// Note: This is NOT searchable by Pagefind since <head> is outside <main data-pagefind-body>.
// For Pagefind site search, see PageTitle.astro which renders keywords inside the content area.
const propsEntry = Astro.props.entry;
const localsEntry = Astro.locals.starlightRoute?.entry;
const entry = propsEntry || localsEntry;
const keywords = entry?.data?.keywords as string[] | undefined;
---

<Default {...Astro.props}><slot /></Default>

<!-- Force dark mode -->
<script is:inline>
  document.documentElement.dataset.theme = 'dark';
  localStorage.setItem('starlight-theme', 'dark');
</script>

<!-- Font preloads -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

{/* SEO meta tag for external search engines */}
{keywords && keywords.length > 0 && (
  <meta name="keywords" content={keywords.join(', ')} />
)}

<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

    function getTheme() {
        // Starlight uses data-theme attribute
        return document.documentElement.dataset.theme === 'dark' ? 'dark' : 'default';
    }

    function initMermaid() {
        mermaid.initialize({
            startOnLoad: false,
            theme: getTheme(),
        });
    }

    initMermaid();

    // Find all mermaid code blocks and render them
    async function renderMermaid() {
        // Re-initialize with current theme
        initMermaid();

        // Starlight's expressive-code uses data-language attribute on pre element
        const mermaidBlocks = document.querySelectorAll('pre[data-language="mermaid"]');

        for (const pre of mermaidBlocks) {
            // The structure is: div.expressive-code > figure > pre > code > div.ec-line
            const wrapper = pre.closest('.expressive-code');

            // Extract code from ec-line divs, preserving newlines
            const lines = pre.querySelectorAll('.ec-line');
            const code = Array.from(lines).map(line => line.textContent || '').join('\n');

            // Create wrapper with controls
            const container = document.createElement('div');
            container.className = 'mermaid-wrapper';
            container.dataset.mermaidCode = code; // Store code for theme re-rendering

            const controls = document.createElement('div');
            controls.className = 'mermaid-controls';
            controls.innerHTML = `
                <button class="mermaid-btn mermaid-zoom-in" title="Zoom in">+</button>
                <button class="mermaid-btn mermaid-zoom-out" title="Zoom out">−</button>
                <button class="mermaid-btn mermaid-reset" title="Reset">↺</button>
            `;

            const viewport = document.createElement('div');
            viewport.className = 'mermaid-viewport';

            const diagram = document.createElement('div');
            diagram.className = 'mermaid';

            try {
                const { svg } = await mermaid.render(`mermaid-${Math.random().toString(36).slice(2)}`, code);
                diagram.innerHTML = svg;

                viewport.appendChild(diagram);
                container.appendChild(controls);
                container.appendChild(viewport);

                // Set up zoom/pan
                let scale = 1;
                let panX = 0;
                let panY = 0;
                let isPanning = false;
                let startX = 0;
                let startY = 0;

                function updateTransform() {
                    diagram.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
                }

                controls.querySelector('.mermaid-reset').addEventListener('click', () => {
                    scale = 1;
                    panX = 0;
                    panY = 0;
                    updateTransform();
                });

                viewport.addEventListener('mousedown', (e) => {
                    isPanning = true;
                    startX = e.clientX - panX;
                    startY = e.clientY - panY;
                    viewport.style.cursor = 'grabbing';
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isPanning) return;
                    panX = e.clientX - startX;
                    panY = e.clientY - startY;
                    updateTransform();
                });

                document.addEventListener('mouseup', () => {
                    isPanning = false;
                    viewport.style.cursor = 'grab';
                });

                controls.querySelector('.mermaid-zoom-in').addEventListener('click', () => {
                    scale = Math.min(4, scale * 1.2);
                    updateTransform();
                });

                controls.querySelector('.mermaid-zoom-out').addEventListener('click', () => {
                    scale = Math.max(0.25, scale * 0.8);
                    updateTransform();
                });

                // Preserve any <link>/<script> elements (EC assets) before replacing
                if (wrapper) {
                    wrapper.querySelectorAll(':scope > link, :scope > script').forEach(el => {
                        wrapper.parentNode.insertBefore(el, wrapper);
                    });
                }
                // Replace the entire expressive-code wrapper
                (wrapper || pre).replaceWith(container);
            } catch (e) {
                console.error('Mermaid rendering failed:', e);
            }
        }
    }

    // Run on page load and after view transitions
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', renderMermaid);
    } else {
        renderMermaid();
    }
    document.addEventListener('astro:after-swap', renderMermaid);

    // Re-render existing diagrams on theme change
    async function reRenderMermaid() {
        initMermaid();
        const wrappers = document.querySelectorAll('.mermaid-wrapper[data-mermaid-code]');

        for (const wrapper of wrappers) {
            const code = wrapper.dataset.mermaidCode;
            if (!code) continue;

            const diagram = wrapper.querySelector('.mermaid');
            if (!diagram) continue;

            try {
                const { svg } = await mermaid.render(`mermaid-${Math.random().toString(36).slice(2)}`, code);
                diagram.innerHTML = svg;
            } catch (e) {
                console.error('Mermaid re-rendering failed:', e);
            }
        }
    }

    // Re-render on theme change
    const observer = new MutationObserver((mutations) => {
        for (const mutation of mutations) {
            if (mutation.attributeName === 'data-theme') {
                reRenderMermaid();
            }
        }
    });
    observer.observe(document.documentElement, { attributes: true });
</script>

<style is:global>
    /* Hide raw mermaid code blocks until they are rendered into diagrams */
    .expressive-code:has(pre[data-language="mermaid"]) {
        visibility: hidden;
        height: 0;
        overflow: hidden;
        margin: 0;
        padding: 0;
    }

    .mermaid-wrapper {
        position: relative;
        margin: 1.5rem 0;
        border: 1px solid var(--sl-color-gray-5);
        border-radius: 0.5rem;
        overflow: hidden;
        background: var(--sl-color-bg);
    }

    .mermaid-controls {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 4px;
        z-index: 10;
    }

    .mermaid-btn {
        width: 1.5rem;
        height: 1.5rem;
        margin: 0;
        padding: 0;
        border: 1px solid var(--sl-color-gray-5);
        border-radius: 0.125rem;
        background: var(--sl-color-bg);
        color: var(--sl-color-text);
        cursor: pointer;
        font-size: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.15s, border-color 0.15s;
    }

    .mermaid-btn:hover {
        background: var(--sl-color-gray-6);
        border-color: var(--sl-color-gray-4);
    }

    .mermaid-viewport {
        overflow: hidden;
        min-height: 200px;
        cursor: grab;
        padding: 1rem;
    }

    .mermaid-viewport:active {
        cursor: grabbing;
    }

    .mermaid {
        display: block;
        width: 100%;
        transform-origin: center center;
        transition: transform 0.1s ease-out;
    }

    .mermaid svg {
        width: 100%;
        height: auto;
    }

    /* Image lightbox */
    .sl-markdown-content img {
        cursor: zoom-in;
    }

    .lightbox-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        cursor: zoom-out;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, visibility 0.2s;
    }

    .lightbox-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .lightbox-overlay img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 0.5rem;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.5);
        transform: scale(0.9);
        transition: transform 0.2s ease-out;
    }

    .lightbox-overlay.active img {
        transform: scale(1);
    }

    .lightbox-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 2.5rem;
        height: 2.5rem;
        border: none;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.15s;
    }

    .lightbox-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }
</style>

<script>
    // Image lightbox
    function initLightbox() {
        // Create overlay if it doesn't exist
        let overlay = document.querySelector('.lightbox-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.className = 'lightbox-overlay';
            overlay.innerHTML = `
                <button class="lightbox-close" aria-label="Close">&times;</button>
                <img src="" alt="" />
            `;
            document.body.appendChild(overlay);

            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay || e.target.classList.contains('lightbox-close')) {
                    overlay.classList.remove('active');
                }
            });

            // Close on Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && overlay.classList.contains('active')) {
                    overlay.classList.remove('active');
                }
            });
        }

        // Add click handlers to content images
        const contentImages = document.querySelectorAll('.sl-markdown-content img');
        contentImages.forEach(img => {
            if (img.dataset.lightboxInit) return;
            img.dataset.lightboxInit = 'true';

            img.addEventListener('click', () => {
                const overlayImg = overlay.querySelector('img');
                overlayImg.src = img.src;
                overlayImg.alt = img.alt;
                overlay.classList.add('active');
            });
        });
    }

    // Run on load and after view transitions
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLightbox);
    } else {
        initLightbox();
    }
    document.addEventListener('astro:after-swap', initLightbox);
</script>
