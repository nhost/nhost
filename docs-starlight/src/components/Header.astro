---
import type { Props } from '@astrojs/starlight/props';
import Default from '@astrojs/starlight/components/Header.astro';

const products = [
    { label: 'Overview', href: '/products/overview/' },
    { label: 'Database', href: '/products/database/overview/' },
    { label: 'GraphQL', href: '/products/graphql/overview/' },
    { label: 'Auth', href: '/products/auth/overview/' },
    { label: 'Storage', href: '/products/storage/overview/' },
    { label: 'Run', href: '/products/run/overview/' },
    { label: 'Functions', href: '/products/functions/overview/' },
    { label: 'AI', href: '/products/ai/overview/' },
];

const navLinks = [
    { label: 'Welcome', href: '/' },
    { label: 'Getting Started', href: '/getting-started/overview/' },
    { label: 'Products', href: '/products/overview/', hasDropdown: true, dropdownItems: products },
    { label: 'Platform', href: '/platform/overview/' },
    { label: 'Reference', href: '/reference/overview/' },
    { label: 'Blog', href: 'https://nhost.io/blog', external: true },
];

// Determine current section from URL
const pathname = Astro.url.pathname;
const currentSection = navLinks.find(link => {
    if (link.external) return false;
    // Handle root/welcome page specifically - only match exact root
    if (link.href === '/') {
        return pathname === '/' || pathname === '/welcome' || pathname === '/welcome/';
    }
    // For section pages, check if pathname starts with the section base path
    const basePath = link.href.replace('/overview/', '/').replace(/\/$/, '');
    return pathname.startsWith(basePath);
});
---

<Default {...Astro.props}>
    <slot />
</Default>

<style is:global>
    /* Subheader navigation */
    .subheader-nav {
        display: none;
        width: 100%;
        flex: 0 0 100%;
        align-items: stretch;
        justify-content: space-between;
        padding: 0 var(--sl-nav-pad-x) 0 calc(var(--sl-nav-pad-x) - 2rem);
        border-top: 1px solid var(--sl-color-hairline-light);
        background: var(--sl-color-bg-nav);
    }

    .subheader-links {
        display: flex;
        align-items: stretch;
        gap: 0;
    }

    .subheader-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .subheader-link {
        display: flex;
        align-items: center;
        padding: 0.5rem 0;
        font-weight: 500;
        font-size: 0.875rem;
        text-decoration: none;
        white-space: nowrap;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        transition: color 0.15s, border-color 0.15s;
        color: var(--sl-color-gray-3);
    }

    .subheader-link + .subheader-link,
    .subheader-link + .dropdown-container,
    .dropdown-container + .subheader-link,
    .dropdown-container + .dropdown-container {
        margin-left: 1.5rem;
    }

    .subheader-link:hover {
        color: var(--sl-color-gray-1);
    }

    .subheader-link.active {
        color: var(--sl-color-text-accent);
        border-bottom-color: var(--sl-color-text-accent);
    }

    /* Dropdown styles */
    .dropdown-container {
        position: relative;
        display: flex;
        align-items: stretch;
    }

    .dropdown-trigger {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        font-family: inherit;
    }

    .dropdown-arrow {
        transition: transform 0.2s;
    }

    .dropdown-container:hover .dropdown-arrow,
    .dropdown-container.open .dropdown-arrow {
        transform: rotate(180deg);
    }

    .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        min-width: 160px;
        padding: 0.5rem 0;
        background: var(--sl-color-bg-nav);
        border: 1px solid var(--sl-color-hairline-light);
        border-radius: 0.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        opacity: 0;
        visibility: hidden;
        transform: translateY(-4px);
        transition: opacity 0.15s, transform 0.15s, visibility 0.15s;
        z-index: 100;
    }

    .dropdown-container:hover .dropdown-menu,
    .dropdown-container.open .dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .dropdown-item {
        display: block;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        color: var(--sl-color-gray-3);
        transition: background 0.15s, color 0.15s;
    }

    .dropdown-item:hover {
        background: var(--sl-color-gray-6);
        color: var(--sl-color-gray-1);
    }

    .action-link {
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        color: var(--sl-color-gray-3);
        transition: color 0.15s;
    }

    .action-link:hover {
        color: var(--sl-color-gray-1);
    }

    .action-button {
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        padding: 0.375rem 0.875rem;
        border-radius: 0.375rem;
        background: var(--sl-color-text-accent);
        color: black;
        transition: opacity 0.15s;
    }

    .action-button:hover {
        opacity: 0.9;
    }

    /* Show on desktop */
    @media (min-width: 50rem) {
        /* Make header wrap */
        header.header {
            flex-wrap: wrap !important;
            height: auto !important;
            border-bottom: none !important;
            padding-bottom: 0 !important;
            background-color: rgba(8, 8, 8, 0.6) !important;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        /* Light mode */
        [data-theme='light'] header.header {
            background-color: rgba(255, 255, 255, 0.6) !important;
        }

        .subheader-nav.visible {
            display: flex;
            background: transparent;
        }
    }
</style>

<nav class="subheader-nav" aria-label="Main sections" id="subheader-nav">
    <div class="subheader-links">
        {navLinks.map(link => (
            link.hasDropdown ? (
                <div class="dropdown-container">
                    <button
                        class:list={[
                            'subheader-link',
                            'dropdown-trigger',
                            { active: currentSection?.href === link.href }
                        ]}
                        aria-expanded="false"
                        aria-haspopup="true"
                    >
                        {link.label}
                        <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <div class="dropdown-menu">
                        {link.dropdownItems?.map(item => (
                            <a
                                href={item.href}
                                class="dropdown-item"
                            >
                                {item.label}
                            </a>
                        ))}
                    </div>
                </div>
            ) : (
                <a
                    href={link.href}
                    class:list={[
                        'subheader-link',
                        { active: currentSection?.href === link.href }
                    ]}
                    aria-current={currentSection?.href === link.href ? 'page' : undefined}
                    target={link.external ? '_blank' : undefined}
                    rel={link.external ? 'noopener noreferrer' : undefined}
                >
                    {link.label}
                </a>
            )
        ))}
    </div>
    <div class="subheader-actions">
        <a href="https://app.nhost.io/support" class="action-link" target="_blank" rel="noopener noreferrer">Support</a>
        <a href="https://app.nhost.io" class="action-button" target="_blank" rel="noopener noreferrer">Dashboard</a>
    </div>
</nav>

<script>
    // Move subheader nav inside the header
    const nav = document.getElementById('subheader-nav');
    const header = document.querySelector('header.header');
    if (nav && header) {
        header.appendChild(nav);
        nav.classList.add('visible');
    }

    // Handle dropdown click toggle (for touch/keyboard accessibility)
    document.querySelectorAll('.dropdown-trigger').forEach(trigger => {
        trigger.addEventListener('click', (e) => {
            const container = trigger.closest('.dropdown-container');
            const isOpen = container?.classList.contains('open');

            // Close all other dropdowns
            document.querySelectorAll('.dropdown-container.open').forEach(el => {
                el.classList.remove('open');
                el.querySelector('.dropdown-trigger')?.setAttribute('aria-expanded', 'false');
            });

            // Toggle this dropdown
            if (!isOpen && container) {
                container.classList.add('open');
                trigger.setAttribute('aria-expanded', 'true');
            }
        });
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
        if (!(e.target as Element).closest('.dropdown-container')) {
            document.querySelectorAll('.dropdown-container.open').forEach(el => {
                el.classList.remove('open');
                el.querySelector('.dropdown-trigger')?.setAttribute('aria-expanded', 'false');
            });
        }
    });

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.querySelectorAll('.dropdown-container.open').forEach(el => {
                el.classList.remove('open');
                el.querySelector('.dropdown-trigger')?.setAttribute('aria-expanded', 'false');
            });
        }
    });
</script>
