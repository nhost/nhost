---
import Default from '@astrojs/starlight/components/Header.astro';
import type { Props } from '@astrojs/starlight/props';

const products = [
  { label: 'Overview', href: '/products/' },
  { label: 'Database', href: '/products/database/' },
  { label: 'GraphQL', href: '/products/graphql/' },
  { label: 'Auth', href: '/products/auth/' },
  { label: 'Storage', href: '/products/storage/' },
  { label: 'Run', href: '/products/run/' },
  { label: 'Functions', href: '/products/functions/' },
  { label: 'AI', href: '/products/ai/' },
];

const navLinks = [
  { label: 'Welcome', href: '/' },
  { label: 'Getting Started', href: '/getting-started/' },
  {
    label: 'Products',
    href: '/products/',
    hasDropdown: true,
    dropdownItems: products,
  },
  { label: 'Platform', href: '/platform/' },
  { label: 'Reference', href: '/reference/' },
  { label: 'Blog', href: 'https://nhost.io/blog', external: true },
];

// Determine current section from URL
const pathname = Astro.url.pathname;
const currentSection = navLinks.find((link) => {
  if (link.external) return false;
  // Handle root/welcome page specifically - only match exact root
  if (link.href === '/') {
    return (
      pathname === '/' || pathname === '/welcome' || pathname === '/welcome/'
    );
  }
  // For section pages, check if pathname starts with the section base path
  const basePath = link.href.replace('/', '/').replace(/\/$/, '');
  return pathname.startsWith(basePath);
});
---

<Default {...Astro.props}>
    <slot />
</Default>

<style is:global>
    /* Subheader: hidden on mobile, visible on desktop */
    .subheader-nav {
        display: none;
    }

    @media (min-width: 50rem) {
        .subheader-nav {
            display: flex;
            position: fixed;
            top: var(--sl-nav-height);
            left: 0;
            right: 0;
            z-index: var(--sl-z-index-navbar);
            width: 100%;
            height: var(--custom-subheader-height);
            align-items: stretch;
            justify-content: space-between;
            padding: 0 var(--sl-nav-pad-x);
            background: var(--sl-color-bg);
            border-bottom: 1px solid var(--sl-color-hairline-light);
        }
    }

    .subheader-links {
        display: flex;
        align-items: stretch;
        gap: 0;
    }

    .subheader-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .subheader-link {
        display: flex;
        align-items: center;
        padding: 0;
        font-weight: 500;
        font-size: 0.875rem;
        text-decoration: none;
        white-space: nowrap;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        transition: color 0.15s, border-color 0.15s;
        color: var(--sl-color-gray-3);
    }

    .subheader-link + .subheader-link,
    .subheader-link + .dropdown-container,
    .dropdown-container + .subheader-link,
    .dropdown-container + .dropdown-container {
        margin-left: 1.5rem;
    }

    .subheader-link:hover {
        color: var(--sl-color-gray-1);
    }

    .subheader-link.active {
        color: var(--sl-color-text-accent);
        border-bottom-color: var(--sl-color-text-accent);
    }

    /* Dropdown styles */
    .dropdown-container {
        position: relative;
        display: flex;
        align-items: stretch;
    }

    .dropdown-trigger {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        font-family: inherit;
    }

    .dropdown-arrow {
        transition: transform 0.2s;
    }

    .dropdown-container:hover .dropdown-arrow,
    .dropdown-container.open .dropdown-arrow {
        transform: rotate(180deg);
    }

    .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        min-width: 160px;
        padding: 0.5rem 0;
        background: var(--sl-color-bg-nav);
        border: 1px solid var(--sl-color-hairline-light);
        border-radius: 0.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        opacity: 0;
        visibility: hidden;
        transform: translateY(-4px);
        transition: opacity 0.15s, transform 0.15s, visibility 0.15s;
        z-index: 100;
    }

    .dropdown-container:hover .dropdown-menu,
    .dropdown-container.open .dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .dropdown-item {
        display: block;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        color: var(--sl-color-gray-3);
        transition: background 0.15s, color 0.15s;
    }

    .dropdown-item:hover {
        background: var(--sl-color-gray-6);
        color: var(--sl-color-gray-1);
    }

    .action-link {
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        color: var(--sl-color-gray-3);
        transition: color 0.15s;
    }

    .action-link:hover {
        color: var(--sl-color-gray-1);
    }

    .action-button {
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        padding: 0.375rem 0.875rem;
        border-radius: 0.375rem;
        background: var(--sl-color-text-accent);
        color: black;
        transition: opacity 0.15s;
    }

    .action-button:hover {
        opacity: 0.9;
    }

    /* Mobile navigation */
    .mobile-nav {
        display: block;
        position: fixed;
        top: var(--sl-nav-height);
        left: 0;
        right: 0;
        background: var(--sl-color-bg);
        border-bottom: 1px solid var(--sl-color-hairline-light);
        z-index: 9;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }

    .mobile-nav.open {
        max-height: 100vh;
        overflow-y: auto;
    }

    .mobile-nav-toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        height: var(--custom-mobile-nav-height);
        padding: 0 1rem;
        background: var(--sl-color-bg);
        border: none;
        border-bottom: 1px solid var(--sl-color-hairline-light);
        color: var(--sl-color-text);
        font-family: inherit;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        position: fixed;
        top: var(--sl-nav-height);
        left: 0;
        right: 0;
        z-index: 10;
    }

    .mobile-nav-toggle svg {
        transition: transform 0.2s;
    }

    .mobile-nav-toggle.open svg {
        transform: rotate(180deg);
    }

    .mobile-nav-content {
        padding: 0.5rem 0;
        margin-top: calc(var(--sl-nav-height) + var(--custom-mobile-nav-height));
    }

    .mobile-nav-section {
        padding: 0.5rem 1rem;
    }

    .mobile-nav-section-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--sl-color-gray-3);
        margin-bottom: 0.5rem;
    }

    .mobile-nav-link {
        display: block;
        padding: 0.5rem 0;
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        color: var(--sl-color-gray-2);
        transition: color 0.15s;
    }

    .mobile-nav-link:hover,
    .mobile-nav-link.active {
        color: var(--sl-color-text-accent);
    }

    .mobile-nav-actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        padding: 1rem;
        border-top: 1px solid var(--sl-color-hairline-light);
        margin-top: 0.5rem;
    }

    /* Solid header on mobile, transparent on tablet+ */
    header.header {
        background-color: var(--sl-color-bg) !important;
        border-bottom: 1px solid var(--sl-color-hairline-light) !important;
    }

    /* Hide the border/gap where theme toggle used to be */
    .social-icons::after {
        display: none !important;
    }

    @media (min-width: 50rem) {
        header.header {
            background-color: var(--sl-color-bg) !important;
            border-bottom: 1px solid var(--sl-color-hairline-light) !important;
        }
    }

    /* Show on desktop */
    @media (min-width: 50rem) {
        .mobile-nav,
        .mobile-nav-toggle {
            display: none !important;
        }
    }
</style>

<!-- Mobile navigation toggle and menu -->
<button class="mobile-nav-toggle" id="mobile-nav-toggle" aria-expanded="false" aria-controls="mobile-nav">
    <span>{currentSection?.label || 'Navigate'}</span>
    <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
</button>

<nav class="mobile-nav" id="mobile-nav" aria-label="Mobile navigation">
    <div class="mobile-nav-content">
        <div class="mobile-nav-section">
            <div class="mobile-nav-section-title">Sections</div>
            {navLinks.map(link => (
                !link.hasDropdown ? (
                    <a
                        href={link.href}
                        class:list={['mobile-nav-link', { active: currentSection?.href === link.href }]}
                        target={link.external ? '_blank' : undefined}
                        rel={link.external ? 'noopener noreferrer' : undefined}
                    >
                        {link.label}
                    </a>
                ) : null
            ))}
        </div>
        <div class="mobile-nav-section">
            <div class="mobile-nav-section-title">Products</div>
            {products.map(product => (
                <a href={product.href} class="mobile-nav-link">
                    {product.label}
                </a>
            ))}
        </div>
        <div class="mobile-nav-actions">
            <a href="https://app.nhost.io/support" class="action-link" target="_blank" rel="noopener noreferrer">Support</a>
            <a href="https://app.nhost.io" class="action-button" target="_blank" rel="noopener noreferrer">Dashboard</a>
        </div>
    </div>
</nav>

<nav class="subheader-nav" aria-label="Main sections" id="subheader-nav">
    <div class="subheader-links">
        {navLinks.map(link => (
            link.hasDropdown ? (
                <div class="dropdown-container">
                    <button
                        class:list={[
                            'subheader-link',
                            'dropdown-trigger',
                            { active: currentSection?.href === link.href }
                        ]}
                        aria-expanded="false"
                        aria-haspopup="true"
                    >
                        {link.label}
                        <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <div class="dropdown-menu">
                        {link.dropdownItems?.map(item => (
                            <a
                                href={item.href}
                                class="dropdown-item"
                            >
                                {item.label}
                            </a>
                        ))}
                    </div>
                </div>
            ) : (
                <a
                    href={link.href}
                    class:list={[
                        'subheader-link',
                        { active: currentSection?.href === link.href }
                    ]}
                    aria-current={currentSection?.href === link.href ? 'page' : undefined}
                    target={link.external ? '_blank' : undefined}
                    rel={link.external ? 'noopener noreferrer' : undefined}
                >
                    {link.label}
                </a>
            )
        ))}
    </div>
    <div class="subheader-actions">
        <a href="https://app.nhost.io/support" class="action-link" target="_blank" rel="noopener noreferrer">Support</a>
        <a href="https://app.nhost.io" class="action-button" target="_blank" rel="noopener noreferrer">Dashboard</a>
    </div>
</nav>

<script>
    // Mobile navigation toggle
    const mobileNavToggle = document.getElementById('mobile-nav-toggle');
    const mobileNav = document.getElementById('mobile-nav');

    if (mobileNavToggle && mobileNav) {
        mobileNavToggle.addEventListener('click', () => {
            const isOpen = mobileNav.classList.contains('open');
            mobileNav.classList.toggle('open');
            mobileNavToggle.classList.toggle('open');
            mobileNavToggle.setAttribute('aria-expanded', String(!isOpen));
        });

        // Close mobile nav when clicking a link
        mobileNav.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', () => {
                mobileNav.classList.remove('open');
                mobileNavToggle.classList.remove('open');
                mobileNavToggle.setAttribute('aria-expanded', 'false');
            });
        });

        // Close on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && mobileNav.classList.contains('open')) {
                mobileNav.classList.remove('open');
                mobileNavToggle.classList.remove('open');
                mobileNavToggle.setAttribute('aria-expanded', 'false');
            }
        });

        // Close on view transition
        document.addEventListener('astro:before-swap', () => {
            mobileNav.classList.remove('open');
            mobileNavToggle.classList.remove('open');
            mobileNavToggle.setAttribute('aria-expanded', 'false');
        });
    }

    // Handle dropdown click toggle (for touch/keyboard accessibility)
    document.querySelectorAll('.dropdown-trigger').forEach(trigger => {
        trigger.addEventListener('click', (e) => {
            const container = trigger.closest('.dropdown-container');
            const isOpen = container?.classList.contains('open');

            // Close all other dropdowns
            document.querySelectorAll('.dropdown-container.open').forEach(el => {
                el.classList.remove('open');
                el.querySelector('.dropdown-trigger')?.setAttribute('aria-expanded', 'false');
            });

            // Toggle this dropdown
            if (!isOpen && container) {
                container.classList.add('open');
                trigger.setAttribute('aria-expanded', 'true');
            }
        });
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
        if (!(e.target as Element).closest('.dropdown-container')) {
            document.querySelectorAll('.dropdown-container.open').forEach(el => {
                el.classList.remove('open');
                el.querySelector('.dropdown-trigger')?.setAttribute('aria-expanded', 'false');
            });
        }
    });

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.querySelectorAll('.dropdown-container.open').forEach(el => {
                el.classList.remove('open');
                el.querySelector('.dropdown-trigger')?.setAttribute('aria-expanded', 'false');
            });
        }
    });
</script>
